<!DOCTYPE html>

<html>
<head>
  <title>cleandocs</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="cleandocs">cleandocs</h1>
<p>This is the file where everything starts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>{fileUtil} = <span class="hljs-built_in">require</span> <span class="hljs-string">'./fileUtil'</span>
path = <span class="hljs-built_in">require</span> <span class="hljs-string">"path"</span>
{DocMerger} = <span class="hljs-built_in">require</span> <span class="hljs-string">'./DocMerger'</span>
doccoUtil = <span class="hljs-built_in">require</span> <span class="hljs-string">'./doccoUtil'</span>
_ = <span class="hljs-built_in">require</span> <span class="hljs-string">'lodash'</span>

doccoCssDir = <span class="hljs-string">"node_modules/docco/resources/parallel"</span>
doccoCssFile = <span class="hljs-string">"docco.css"</span>
doccoPublicDir = <span class="hljs-string">"public"</span>

<span class="hljs-function"><span class="hljs-title">readOptionsFile</span> = -&gt;</span>
  fileUtil.readJson <span class="hljs-string">'cleandocs.json'</span>

<span class="hljs-function"><span class="hljs-title">processOptionsFile</span> = <span class="hljs-params">(optionsFile)</span> -&gt;</span>
  _.map optionsFile.dirs, <span class="hljs-function"><span class="hljs-params">(nextDirs)</span> -&gt;</span>
    nextOptions = _.pick optionsFile, <span class="hljs-string">'docSuffix'</span>, <span class="hljs-string">'docTagStart'</span>, <span class="hljs-string">'docTagEnd'</span>,
      <span class="hljs-string">'srcSuffix'</span>, <span class="hljs-string">'srcTagStart'</span>, <span class="hljs-string">'srcTagEnd'</span>, <span class="hljs-string">'outputSuffix'</span>,
      <span class="hljs-string">'defaultTagOrder'</span>, <span class="hljs-string">'docco'</span>
    nextOptions.docDir = nextDirs.docs
    nextOptions.srcDir = nextDirs.src
    nextOptions.outputDir = nextDirs.output
    nextOptions

<span class="hljs-function"><span class="hljs-title">getOptions</span> = -&gt;</span>
  processOptionsFile readOptionsFile()

<span class="hljs-function"><span class="hljs-title">mergeAndWriteAllFiles</span> = <span class="hljs-params">(pairedFiles, options)</span> -&gt;</span>
  {docDir, docSuffix, docTagStart, docTagEnd, srcDir, srcSuffix, srcTagStart,
    srcTagEnd, outputDir, outputSuffix, defaultTagOrder, docco} = options


  fileUtil.cleanDirectory outputDir

  <span class="hljs-keyword">if</span> docco
    fileUtil.copyFile doccoCssDir, doccoCssFile, options.outputDir
    fileUtil.copyFile doccoCssDir, doccoPublicDir, options.outputDir

  _.each pairedFiles, <span class="hljs-function"><span class="hljs-params">(docFile, docFileName)</span> -&gt;</span>
    docLines = fileUtil.getFileLines docDir, docFileName
    outFileName = fileUtil.swapSuffixes docSuffix, outputSuffix, docFileName
    <span class="hljs-keyword">if</span> docFile.srcFile
      srcFileName = fileUtil.swapSuffixes docSuffix, srcSuffix, docFileName
      srcLines = fileUtil.getFileLines srcDir, srcFileName
      mergedFile = DocMerger.mergeDocFiles
        <span class="hljs-attribute">docTagStart</span>: docTagStart
        <span class="hljs-attribute">docTagEnd</span>: docTagEnd
        <span class="hljs-attribute">srcTagStart</span>: srcTagStart
        <span class="hljs-attribute">srcTagEnd</span>: srcTagEnd
        <span class="hljs-attribute">defaultTagOrder</span>: defaultTagOrder
        <span class="hljs-attribute">docLines</span>: docLines
        <span class="hljs-attribute">srcLines</span>: srcLines
    <span class="hljs-keyword">else</span>
      mergedFile = docLines.join <span class="hljs-string">"\n"</span>

    <span class="hljs-keyword">if</span> docco
      doccoUtil.doccoFile outFileName, mergedFile, outputDir

    fileUtil.saveFile outputDir, outFileName, mergedFile

<span class="hljs-function"><span class="hljs-title">processAllFiles</span> = <span class="hljs-params">(options)</span> -&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">"processing all <span class="hljs-subst">#{options.docSuffix}</span> files in directory <span class="hljs-subst">#{options.docDir}</span>"</span>
  docFiles = fileUtil.findFilesWithSuffix options.docDir, options.docSuffix
  pairedFiles = fileUtil.pairSourceFiles options.srcDir, options.srcSuffix, options.docSuffix, docFiles
  mergeAndWriteAllFiles pairedFiles, options

<span class="hljs-function"><span class="hljs-title">processAllDirs</span> = <span class="hljs-params">(fileOptions)</span> -&gt;</span>
  _.forEach processOptionsFile<span class="hljs-function"><span class="hljs-params">(fileOptions)</span>, <span class="hljs-params">(nextOptions)</span> -&gt;</span>
    processAllFiles nextOptions

<span class="hljs-function"><span class="hljs-title">main</span> = -&gt;</span>
  processAllDirs readOptionsFile()

<span class="hljs-built_in">exports</span>.main = main
<span class="hljs-built_in">exports</span>.mergeAndWriteAllFiles = mergeAndWriteAllFiles
<span class="hljs-built_in">exports</span>.processOptionsFile = processOptionsFile
<span class="hljs-built_in">exports</span>.processAllDirs = processAllDirs</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
